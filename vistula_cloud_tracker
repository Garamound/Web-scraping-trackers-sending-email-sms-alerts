from email.mime.image import MIMEImage
from email.message import EmailMessage
from keep_alive import keep_alive
import matplotlib.pyplot as plt
from bs4 import BeautifulSoup
import http.client
import requests
import smtplib
import json
import time
import re

# http request created in Insomnia
conn = http.client.HTTPSConnection("hydro.imgw.pl")
payload = ""
headers = {
    'Connection': "keep-alive",
    'sec-ch-ua': "^\^Chromium^^;v=^\^92^^, ^\^"
}
#keep_alive()

while True:
    conn.request("GET", "/api/station/hydro?id=150190340", payload, headers)
    res = conn.getresponse()
    source = res.read()
    text = source.decode("utf-8")
    data = json.loads(source)

    #print(json.dumps(data, indent=2))]
    """
    with open('water_data.json', 'r+') as f:
        for item in f: print(item)
        for item in f: item.append("index": 3)

        for item in data['waterStateRecords']:
            json.dump(item, f, indent=2)
        print("Json file is an empty structure.. Pre-filling file with gathered data..")
    """

    records = {"hourly": {}}
    with open('water_data.json', 'r+') as f:
        for item in data['waterStateRecords']:
            entry = {item['date'] : {"state" : item['state'], "value" : item['value']}}
            records['hourly'].update(entry)
        json.dump(records, f, indent=2)

    time.sleep(1000)













